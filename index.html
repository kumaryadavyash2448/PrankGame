<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Personality & Vibe Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#141e30,#243b55);
  color:white;
}
.container{max-width:600px;margin:auto;padding:20px;}
.hidden{display:none;}
h1,h2{text-align:center;}

.option{
  width:90%;
  margin:12px auto;
  padding:18px;
  border-radius:50px;
  font-size:18px;
  background:rgba(255,255,255,0.15);
  color:white;
  border:2px solid rgba(255,255,255,0.3);
}
.option:hover{background:rgba(255,255,255,0.3);}

.primary-btn{
  padding:14px 25px;
  font-size:18px;
  border-radius:40px;
  background:#00c6ff;
  color:black;
  display:block;
  margin:20px auto;
}

.loader{
  width:60px;height:60px;
  border:7px solid rgba(255,255,255,0.3);
  border-top:7px solid #00c6ff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:30px auto;
}
@keyframes spin{100%{transform:rotate(360deg);}}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
td,th{
  border:1px solid rgba(255,255,255,0.3);
  padding:6px;
  vertical-align:top;
}
</style>
</head>

<body>
<div class="container">

<!-- LANDING -->
<div id="landing">
  <h1>Personality & Vibe Test üîÆ</h1>
  <p style="text-align:center">Answer honestly‚Ä¶ or try üòè</p>
  <button class="primary-btn" onclick="startTest()">Start</button>
</div>

<!-- QUESTIONS -->
<div id="questionBox" class="hidden">
  <h2 id="qNo"></h2>
  <p id="qText" style="text-align:center"></p>
  <div id="options"></div>
</div>

<!-- LOADING -->
<div id="loading" class="hidden">
  <div class="loader"></div>
  <p id="loadingText" style="text-align:center"></p>
</div>

<!-- RESULT -->
<div id="result" class="hidden">
  <h2>Result</h2>
  <p id="lie"></p>
  <p id="fun"></p>
  <p id="personality"></p>
  <p id="vibe"></p>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <h2>Creator Portal</h2>
  <input id="nick" placeholder="Link nickname" style="width:100%;padding:10px">
  <button class="primary-btn" onclick="createLink()">Create Link</button>

  <table>
    <thead>
      <tr>
        <th>Nickname</th>
        <th>Status</th>
        <th>Link</th>
        <th>Lie%</th>
        <th>Answers</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>
</div>

</div>

<script>
/* ===== CONFIG ===== */
const ADMIN_KEY = "K9xP7Q2LmZ";
const BASE_URL = window.location.origin + window.location.pathname.replace(/\/$/, "");

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyAuLOmBQ3xKNcYN2rzOo-3gY3-2UqIIyWk",
  authDomain: "prankgame-6ad46.firebaseapp.com",
  projectId: "prankgame-6ad46",
});
const db = firebase.firestore();

/* ===== QUESTIONS ===== */
const questions = [
 {q:"Have you ever dreamed about your future?", o:["YES","NO","MAYBE"]},
 {q:"Was this year actually good for you?", o:["YES","NO","NOT SURE"]},
 {q:"Have you ever been lost in someone's thoughts?", o:["YES","NO","MAYBE"]},
 {q:"Have you avoided someone intentionally?", o:["YES","NO","MAYBE"]},
 {q:"Have you replayed conversations in your head?", o:["YES","NO","MAYBE"]},
 {q:"Have you pretended to know something?", o:["YES","NO","MAYBE"]},
 {q:"Do people know the real you?", o:["YES","NO","NOT REALLY"]},
 {q:"Have you felt insecure around a friend?", o:["YES","NO","MAYBE"]},
 {q:"Have you hidden true feelings when asked?", o:["YES","NO","MAYBE"]},
 {q:"Have you found a better person than admin üòÖ", o:["No üòµ‚Äçüí´","Yash üòÅ"], skip:true}
];

/* ===== STATE ===== */
let i = 0;
let answers = [];
const params = new URLSearchParams(window.location.search);
const playId = params.get("play");
const adminKey = params.get("admin");

/* ===== ADMIN MODE ===== */
if (adminKey === ADMIN_KEY) {
  document.getElementById("admin").classList.remove("hidden");
  document.getElementById("landing").classList.add("hidden");
  loadAdmin();
}

/* ===== FRIEND MODE ===== */
async function startTest(){
  if(!playId) return alert("Invalid or expired link");
  const ref = await db.collection("links").doc(playId).get();
  if(!ref.exists || ref.data().status==="used"){
    alert("This link is already used");
    return;
  }
  document.getElementById("landing").classList.add("hidden");
  showQ();
}

function showQ(){
  if(i>=questions.length){ submit(); return; }
  document.getElementById("questionBox").classList.remove("hidden");
  document.getElementById("qNo").innerText=`Question ${i+1}`;
  document.getElementById("qText").innerText=questions[i].q;
  const opt=document.getElementById("options");
  opt.innerHTML="";
  questions[i].o.forEach(v=>{
    const b=document.createElement("button");
    b.className="option";
    b.innerText=v;
    b.onclick=()=>{answers.push({q:questions[i].q,a:v});i++;showQ();};
    opt.appendChild(b);
  });
}

/* ===== SUBMIT ===== */
function submit(){
  document.getElementById("questionBox").classList.add("hidden");
  document.getElementById("loading").classList.remove("hidden");

  const steps=[
    "Calculating honesty level‚Ä¶",
    "Analyzing personality traits‚Ä¶",
    "Processing vibe check‚Ä¶"
  ];
  let s=0;
  document.getElementById("loadingText").innerText=steps[0];
  const interval=setInterval(()=>{
    s++; if(s<steps.length) document.getElementById("loadingText").innerText=steps[s];
  },1200);

  const lie=Math.floor(Math.random()*20)+76;

  setTimeout(()=>{
    clearInterval(interval);
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("result").classList.remove("hidden");
    document.getElementById("lie").innerText="Lie Probability: "+lie+"%";
    document.getElementById("fun").innerText="Truth detected‚Ä¶ but not completely üòè";
    document.getElementById("personality").innerText="Personality: Silent Thinker üß†";
    document.getElementById("vibe").innerText="Vibe: Calm but unpredictable";
  },3800);

  db.collection("links").doc(playId).update({
    status:"used",
    lie,
    answers,
    finishedAt:Date.now()
  });
}

/* ===== ADMIN ===== */
function createLink(){
  const nick=document.getElementById("nick").value.trim();
  if(!nick) return alert("Enter nickname");
  const id="L"+Date.now();
  db.collection("links").doc(id).set({
    nickname:nick,
    status:"unused",
    created:Date.now()
  }).then(()=>{
    navigator.clipboard.writeText(BASE_URL+"?play="+id);
    alert("Link copied!");
    loadAdmin();
  });
}

function loadAdmin(){
  db.collection("links").orderBy("created","desc").onSnapshot(snap=>{
    const t=document.getElementById("adminTable");
    t.innerHTML="";
    snap.forEach(d=>{
      const x=d.data();
      const ans=(x.answers||[]).map(a=>`‚Ä¢ ${a.q} ‚Üí ${a.a}`).join("<br>");
      t.innerHTML+=`
        <tr>
          <td>${x.nickname||""}</td>
          <td>${x.status}</td>
          <td>${BASE_URL}?play=${d.id}</td>
          <td>${x.lie||"-"}</td>
          <td>${ans||"-"}</td>
        </tr>`;
    });
  });
}
</script>
</body>
</html>
