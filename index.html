<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Neural Truth Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui, Arial;
  background:#0b0f1a;
  color:#eafcff;
}
button{
  cursor:pointer;
  border:none;
  border-radius:30px;
  padding:14px 26px;
  font-weight:700;
}
.btn{
  background:linear-gradient(135deg,#00f7ff,#ff3cac);
}
.hidden{display:none}
.container{max-width:800px;margin:auto;padding:20px}

.option{
  width:100%;
  margin:10px 0;
  padding:16px;
  border-radius:40px;
  background:rgba(0,247,255,.12);
  border:1px solid rgba(0,247,255,.4);
  color:white;
}
.option:hover{background:rgba(255,60,172,.25)}

.progress{height:8px;background:#111;border-radius:10px;overflow:hidden}
.progress div{height:100%;width:0%;background:linear-gradient(90deg,#00f7ff,#ff3cac)}

.card{
  padding:14px;
  border-bottom:1px solid #222;
  cursor:pointer;
}
.card:hover{background:#131c3a}
.active{box-shadow:inset 4px 0 #00f7ff}

.danger{
  background:#ff4d4d;
  color:black;
  padding:10px 18px;
}
</style>
</head>
<body>

<div id="app"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyAuLOmBQ3xKNcYN2rzOo-3gY3-2UqIIyWk",
  authDomain:"prankgame-6ad46.firebaseapp.com",
  projectId:"prankgame-6ad46"
});
const db = firebase.firestore();

/* ================= MODE DETECTION ================= */
const ADMIN_KEY = "K9xP7Q2LmZ";
const params = new URLSearchParams(location.search);
const MODE = params.get("admin") === ADMIN_KEY ? "ADMIN" :
             params.get("play") ? "PLAYER" : "INVALID";

/* ================= BOOT ================= */
if(MODE === "ADMIN") renderAdmin();
else if(MODE === "PLAYER") renderPlayer(params.get("play"));
else renderInvalid();

/* ================= INVALID ================= */
function renderInvalid(){
  document.getElementById("app").innerHTML = `
    <div class="container">
      <h2>Invalid or expired link ‚ùå</h2>
    </div>`;
}

/* ================= ADMIN ================= */
function renderAdmin(){
  document.getElementById("app").innerHTML = `
    <div style="display:flex;height:100vh">
      <div style="width:30%;border-right:1px solid #222;overflow:auto" id="list"></div>
      <div style="flex:1;padding:20px">
        <h2>Admin Portal</h2>
        <button class="btn" onclick="createLink()">Create New Link</button>
        <p id="newLink"></p>
        <div id="details">Select a response</div>
      </div>
    </div>`;

  db.collection("links").orderBy("time","desc").onSnapshot(snap=>{
    const list = document.getElementById("list");
    list.innerHTML = "";
    snap.forEach(doc=>{
      const d = doc.data();
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<b>${doc.id}</b><br><small>${d.status}</small>`;
      c.onclick = ()=>showDetails(doc.id,d,c);
      list.appendChild(c);
    });
  });
}

function createLink(){
  const id = "PL_" + Date.now();
  db.collection("links").doc(id).set({
    status:"unused",
    created:Date.now()
  });
  document.getElementById("newLink").innerHTML =
    `Share this link:<br><code>${location.origin+location.pathname}?play=${id}</code>`;
}

function showDetails(id,data,card){
  document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
  card.classList.add("active");

  document.getElementById("details").innerHTML = `
    <p><b>Lie %:</b> ${data.lie ?? "-"}</p>
    <p>${(data.answers||[]).map(a=>`${a.q} ‚Üí ${a.a}`).join("<br>")}</p>
    <button class="danger" onclick="deleteEntry('${id}')">Delete</button>
  `;
}

function deleteEntry(id){
  if(confirm("Delete this response permanently?")){
    db.collection("links").doc(id).delete();
    document.getElementById("details").innerText = "Deleted ‚úî";
  }
}

/* ================= PLAYER ================= */
function renderPlayer(playId){
  const QUESTIONS=[
    "Have you ever smiled at your phone and locked it fast?",
    "Do you overthink conversations at night?",
    "Have you said 'I'm fine' when you weren't?",
    "Do you replay moments that already passed?",
    "Have you hidden feelings when asked directly?",
    "Have you felt insecure around a friend?",
    "Does your mind wake up at 2AM?",
    "Do people know the real you?",
    "Have you pretended not to care?",
    "Is admin the best person you know? üòÖ"
  ];

  let i=0, answers=[];

  document.getElementById("app").innerHTML = `
    <div class="container">
      <h2 id="qNo"></h2>
      <p id="qText"></p>
      <div id="opts"></div>
      <div class="progress"><div id="prog"></div></div>
    </div>`;

  function showQ(){
    if(i>=QUESTIONS.length){finish();return;}
    qNo.innerText = `Question ${i+1}/${QUESTIONS.length}`;
    qText.innerText = QUESTIONS[i];
    opts.innerHTML = "";
    ["YES","NO","MAYBE"].forEach(o=>{
      const b=document.createElement("button");
      b.className="option";
      b.innerText=o;
      b.onclick=()=>{
        answers.push({q:QUESTIONS[i],a:o});
        i++;
        prog.style.width=(i/QUESTIONS.length*100)+"%";
        showQ();
      };
      opts.appendChild(b);
    });
  }

  function finish(){
    const lie = Math.floor(Math.random()*20)+76;
    db.collection("links").doc(playId).update({
      status:"used",
      answers,
      lie,
      time:Date.now()
    });
    document.getElementById("app").innerHTML = `
      <div class="container">
        <h2>Scan Complete</h2>
        <p>Lie Probability: ${lie}%</p>
        <p>Personality: Overthinking Strategist üß†</p>
        <p>Vibe: Calm outside, chaos inside üòå</p>
      </div>`;
  }

  showQ();
}
</script>
</body>
</html>
